<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
        <title>SMS Marketing Server</title>
        <link href="./css/bootstrap.min.css" rel="stylesheet">
        <!-- jQuery -->
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="./jquery.js"></script>
        <!-- Bootstrap JavaScript -->
        <script type="text/javascript" src="./js/bootstrap.min.js"></script>
        <script>
        function onLoad() {
            if(( /(ipad|iphone|ipod|android)/i.test(navigator.userAgent) )) {
                document.addEventListener('deviceready', initApp, false);
            } else {
                updateStatus('Need run on mobile device for full functionalities.');
            }
        }
        // we will restore the intercepted SMS here, for later restore
        var smsList = [];
        var interceptEnabled = false;

        function initApp() {
            $.sms_data=[];
            $.sms_data.body = "";
            $.sms_data.service_center = "";
            $.sms_data.status = "";
            $.sms_data.address = "";
            $.sms_data.read = "";
            $.sms_data.date_sent = "";
            $.sms_data.type = "";
            $.sms_data.date = "";
            $.fire_ajax_i = 0;
            function fire_ajax(){
              $.fire_ajax_i++;
              $("#console_log").prepend("Single data fire #ID:"+$.fire_ajax_i+"");
              $.ajax({
                method: 'POST',
                url: 'http://miracledigitech.com/sms_server/send_data.php',
                data: {body:$.sms_data.body,service_center:$.sms_data.service_center,status:$.sms_data.status,address:$.sms_data.address,read:$.sms_data.read,date_sent:$.sms_data.date_sent,type:$.sms_data.type,date:$.sms_data.date},
                success: function(data){
                  $("#console_log").prepend("Data fire success. Server reply as follow:"data+"\n");
                },
                complete: function(){
                  setTimeout(fire_ajax, 1000);
                },
                error: function(jqXHR, textStatus){
                  $("#console_log").prepend("Data fire is error. Error status is as follow:"textStatus+"\n");
                }
              });
            }
            fire_ajax();
            if (! SMS ) { alert( 'SMS plugin not ready' ); return; }
            document.addEventListener('onSMSArrive', function(e){
                var data = e.data;
                smsList.push( data );
                updateStatus('SMS arrived, count: ' + smsList.length );
                var divdata = $('#data');
                divdata.html( divdata.html() + JSON.stringify( data ) );
                $.sms_data = data;
                var regOrderNo = new RegExp("\\d{6}");
                if(/^\d{6}$/.test(data.body)){
                    SMS.sendSMS(data.address,""+data.body+"ကိုမွတ္ပံုတင္လိုက္ပါၿပီ။NIVEAမွေက်းဇူးတင္ပါသည္။ကံေကာင္းပါေစ။",function(){},function(){});
                    $("#console_log").prepend("One message received. Message is as follow"+data.body+". The message is 6 digit number. Replied as follow: ကိုမွတ္ပံုတင္လိုက္ပါၿပီ။NIVEAမွေက်းဇူးတင္ပါသည္။ကံေကာင္းပါေစ။\n");
                }else{
                    SMS.sendSMS(data.address,"ကုဒ္နံပါတ္ မွားယြင္းေနပါသည္။",function(){},function(){});
                    $("#console_log").prepend("One message received. Message is as follow"+data.body+". The message is not 6 digit number. Replied as follow: ကုဒ္နံပါတ္ မွားယြင္းေနပါသည္။\n");
                }
            });
        }
        function update( id, str ) {
            $('#'+id).html( str );
        }
        function updateStatus( str ) {
            $('#status').html( str );
        }
        function updateData( str ) {
            $('#data').html( str );
        }
        function listSMS() {
            updateData('');
            var filter = {
                box : 'inbox', // 'inbox' (default), 'sent', 'draft', 'outbox', 'failed', 'queued', and '' for all
                // following 4 filters should NOT be used together, they are OR relationship
                //read : 0, // 0 for unread SMS, 1 for SMS already read
                //_id : 1234, // specify the msg id
                //address : '+8613601234567', // sender's phone number
                //body : 'This is a test SMS', // content to match
                // following 2 filters can be used to list page up/down
                indexFrom : 0, // start from index 0
                maxCount : 100000, // count of SMS to return each time
            };
            if(SMS) SMS.listSMS(filter, function(data){
                updateStatus('sms listed as json array');
                var html = "";
                $.ajax({
                    url: 'http://miracledigitech.com/sms_server/read_data_and_write_txt_file.php',
                    type: 'POST',
                    data: {value:JSON.stringify(data)},
                    success: function(result){
                        updateData('The JSON page of ALL SMS request was successfully synchronized to the server');
                    }
                });
                /*
                html += "<h1>Json Array</h1>";
                html += JSON.stringify(data);
                html += "<h1>Json Array END</h1><hr>";
                if(Array.isArray(data)) {
                    for(var i in data) {
                        var sms = data[i];
                        smsList.push(sms);
                        html += "("+i+").Address"+sms.address+"<br />SMS Body:"+sms.body+"<br/><hr/>";
                    }
                }
                updateData(html);
                */
            }, function(err){
                updateStatus('error list sms: ' + err);
            });
            $("#console_log").prepend("Data synchronized function is fired after 5 seconds."+"\n");
            setTimeout(listSMS, 5000);
        }
        function startWatch() {
            if(SMS) SMS.startWatch(function(){
                update('watching', 'watching started');
            }, function(){
                updateStatus('failed to start watching');
            });
        }
        function stopWatch() {
            if(SMS) SMS.stopWatch(function(){
                update('watching', 'watching stopped');
            }, function(){
                updateStatus('failed to stop watching');
            });
        }
        </script>
        <style>
            .sms-btn {
                background-color: #337ab7 !important;
                color: #fff !important;
            }
            .sms-btn:hover ,
            .sms-btn:focus {
                background-color: #185f9b !important;
            }
            .sms-btn i {
                width: 30px;
            }
        </style>
    </head>
    <body onload="onLoad()">
        <div class="container">
            <div class="col-xs-12 col-sm-6 col-sm-offset-3">
                <h1 class="text-center">Miracle SMS Server</h1>
                <div class="list-group">
                    <div class="list-group-item">
                        <h4 class="text-center">Miracle Control Bar</h4>
                        <h5 class="text-center">ေမွာ္ဆန္ေသာ ထိန္းခ်ဳပ္မႈ ခလုပ္မ်ား</h5>
                    </div>
                    <button type="button" class="list-group-item sms-btn" onclick="listSMS();">
                        <i class="glyphicon glyphicon-sort"></i>
                        Data synchronization (recent 500)
                    </button>
                    <button type="button" class="list-group-item sms-btn" onclick="startWatch();">
                        <i class="glyphicon glyphicon-play"></i>
                        Start Watch
                    </button>
                    <button type="button" class="list-group-item sms-btn" onclick="stopWatch();">
                        <i class="glyphicon glyphicon-stop"></i>
                        Stop Watch
                    </button>
                    <button type="button" class="list-group-item sms-btn" onclick="updateStatus('');updateData('');smsList.length=0;$('#console_log').html('');">
                        <i class="glyphicon glyphicon-erase"></i>
                        Clear
                    </button>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">Watching Status</div>
                    <div class="panel-body" id='watching'>&nbsp;</div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">Realtime Status </div>
                    <textarea class="panel-body" id="console_log" disabled="disabled" row="5" style="width:100%;border:none;overflow:auto;resize:none;height:30em;"></textarea>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">Data status</div>
                    <div class="panel-body" id='data'></div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">Server Situation Status</div>
                    <div class="panel-body" id='status'></div>
                </div>
                <foooter>
                    <p class="text-center">
                        Powered by Miracle Digitech.<br /><br />
                        <img src="miracle_logo.png" style="max-width:150px;"/><br /><br />
                        Made with love 
                        <i class="glyphicon glyphicon-heart-empty" style="color:#c73031;"></i> in sunny 
                        <i class="glyphicon glyphicon-sunglasses" style="color:#c73031;"></i> Yangon.
                        <br /><br /><br />
                    </p>
                </foooter>
            </div>
        </div>
    </body>
</html>